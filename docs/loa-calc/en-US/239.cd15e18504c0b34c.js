(()=>{"use strict";function*C(t,n=t.length){for(let i=0;i<t.length;i++)if(1===n)yield[t[i]];else{const e=C([...t.slice(0,i),...t.slice(i+1,t.length)],n-1);for(const o of e)yield[t[i],...o]}}const N=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"];function E(t,n){const i=Object.assign({},t);return n.forEach(([e,o])=>{i[e]||(i[e]=0),i[e]+=o}),i}function L(t,n,i,e,o,c){const a=N.filter(r=>!c.allowedPenalties.includes(r)),O=Object.fromEntries([i.stonePenalty]),h=function(t,n){return Array.from({length:n},(i,e)=>{let o=0;for(let c=e;c<n-1;c+=1)o+=t[c+1][0].price;return o})}(t,n.length);function j(r){return a.find(f=>{var g;return r[f]>=5*Math.floor((null!==(g=O[f])&&void 0!==g?g:0)/5+1)})}const S=n.length;let s=0,l=0;return{composeResults:function u(r,f,g,m,y){if(y===S)return l+=1,function(r){return Object.keys(c.effects).find(f=>r[f]<c.effects[f])}(r)?(s+=1,[]):c.ancientCountMin>0&&Object.values(m).filter(P=>6===P.grade).length<c.ancientCountMin?[]:[{effects:r,price:f,items:Object.assign({},m),stoneBook:i}];const d=[],v=t[y],x=n[y],M=h[y];for(const P of v){if(g.has(P.id)||f+P.price+M>o)continue;const F=E(r,P.effects);j(F)||(g.add(P.id),m[x]=P,d.push(...u(F,f+P.price,g,m,y+1)),g.delete(P.id),delete m[x])}return d}(Object.values(e).reduce((r,f)=>E(r,f.effects),O),0,new Set(Object.values(e).map(r=>r.id)),e,0),totalCount:l,effFilteredCount:s}}function D(t){return JSON.stringify(Object.values(t.items).sort((n,i)=>n.name.localeCompare(i.name)))}function T(t,n){return t.filter(e=>e.isFixed||!function(e){return e.grade<5||!!n.hasBuyPrice&&!e.buyPrice||e.tradeLeft<n.tradeLeft||n.exclude.has(e.id)}(e))}function B(t){return{id:String.fromCharCode(Math.floor(26*Math.random())+97)+Math.random().toString(16).slice(2)+Date.now().toString(16).slice(4),name:"\uc81c\uc678\ub41c \ubd80\uc704",price:0,grade:0,tradeLeft:0,isFixed:!0,effects:t,buyPrice:0,auctionPrice:0,quality:0}}function K(t,n,i,e,o){let c=Array.from(C(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(l=>!e[l])));const a=function(t){return{\uadc0\uac78\uc774:JSON.stringify(t.\uadc0\uac78\uc7741)===JSON.stringify(t.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(t.\ubc18\uc9c01)===JSON.stringify(t.\ubc18\uc9c02)}}(n);a.\uadc0\uac78\uc774&&!(o.ignoredSlots.includes("\uadc0\uac78\uc7741")||o.ignoredSlots.includes("\uadc0\uac78\uc7742"))&&(c=c.filter(l=>l.findIndex(r=>"\uadc0\uac78\uc7741"===r)<l.findIndex(r=>"\uadc0\uac78\uc7742"===r))),a.\ubc18\uc9c0&&!o.ignoredSlots.includes("\ubc18\uc9c01")&&!o.ignoredSlots.includes("\ubc18\uc9c02")&&(c=c.filter(l=>l.findIndex(r=>"\ubc18\uc9c01"===r)<l.findIndex(r=>"\ubc18\uc9c02"===r)));const O=c.length*t.flatMap(l=>l.combinations).length,h=Object.fromEntries(Object.entries(i).map(([l,u])=>[l,T(u,o)]));let j=0,b=0,S=0;const s=new Map;for(const{combinations:l,stoneBook:u}of t){let p=[];for(const r of l)for(const f of c){const g=[];for(let m=0;m<f.length;m+=1){const y=f[m],d=Object.entries(r[m]);if(o.ignoredSlots.includes(y)){if(o.fixedImprintings.includes(d[0][0])||o.fixedImprintings.includes(d[1][0]))continue;g.push([B(d)]);continue}const v=h[`${d[0][0]}_${d[0][1]}_${d[1][0]}_${d[1][1]}_${y}`].sort((x,M)=>x.price-M.price);v.length>0&&g.push(v)}if(g.length===f.length){const m=L(g,f,u,e,p.length?p[p.length-1].price:1/0,o);p.push(...m.composeResults),b+=m.totalCount,S+=m.effFilteredCount;const y={};p.forEach(d=>{y[D(d)]=d}),p=Object.values(y),p.sort((d,v)=>d.price-v.price),p=p.slice(0,300)}j+=1,postMessage({done:!1,total:O,finished:j})}s.set(u,p)}postMessage({done:!0,result:[...s.values()].flat().sort((l,u)=>l.price-u.price),effFilteredRate:S/b})}addEventListener("message",({data:t})=>{K(t.candidates,t.accMap,t.searchResult,t.fixedItems,t.filter)})})();